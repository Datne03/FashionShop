<app-navbar></app-navbar>
<div *ngIf="order" class="card" style="padding:20px">
  <h3 style="margin-bottom: 20px;">ğŸ§¾ Chi tiáº¿t Ä‘Æ¡n hÃ ng #{{ order.id }}</h3>
  <p><strong>NgÃ y Ä‘áº·t:</strong> {{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
  <p><strong>Tráº¡ng thÃ¡i:</strong> {{
    order.status === 'PENDING' ? 'Chá» xá»­ lÃ½' :
    order.status === 'SHIPPED' ? 'Äang giao hÃ ng' :
    order.status === 'CONFIRMED' ? 'Äang xá»­ lÃ½' :
    order.status === 'DELIVERED' ? 'HoÃ n thÃ nh' :
    order.status === 'CANCELED' ? 'ÄÃ£ há»§y' :
    'KhÃ´ng xÃ¡c Ä‘á»‹nh'
    }}</p>
  <p><strong>Tá»•ng tiá»n:</strong> {{ order.totalPrice | currency:'VND' }}</p>

  <h5 class="mt-4">ğŸ“¦ Sáº£n pháº©m:</h5>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Sáº£n pháº©m</th>
        <th>HÃ¬nh áº£nh</th>
        <th *ngIf="order.status === 'PENDING'">Sá»‘ lÆ°á»£ng</th>
        <th *ngIf="order.status !== 'PENDING'">Sá»‘ lÆ°á»£ng</th>
        <th>GiÃ¡</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of order.orderItems">
        <td>{{ item.productVariant.product.name }}</td>
        <td>
          <img style="width: 50px; height: 50px;"
            [src]="'http://localhost:8080/images/product/' + item.productVariant.product.productImages[0]?.imageUrl"
            alt="img">
        </td>
        <td *ngIf="order.status === 'PENDING'">
          <div class="d-flex align-items-center">
            <input [(ngModel)]="item.quantity" type="number" min="1" class="form-control" style="width: 60px;" />
            <button (click)="changeQuantity(item, -1)" class="btn btn-sm btn-secondary ms-2">-</button>
            <button (click)="changeQuantity(item, 1)" class="btn btn-sm btn-primary ms-2">+</button>
          </div>
        </td>
        <td *ngIf="order.status !== 'PENDING'">
          {{ item.quantity }}
        </td>
        <td>{{ item.price | currency:'VND' }}</td>
      </tr>
    </tbody>
  </table>


  <h5 class="mt-4">ğŸ“ Äá»‹a chá»‰ giao hÃ ng:</h5>
  <p>
    {{ order.userAddress.address }}
  </p>

  <div class="d-flex gap-3 mt-2">
    <button *ngIf="order.status === 'PENDING'" (click)="updateOrder()" class="btn btn-primary">Sá»­a Ä‘Æ¡n hÃ ng</button>
    <button *ngIf="order.status === 'PENDING'" (click)="cancelOrder()" class="btn btn-danger">Há»§y Ä‘Æ¡n hÃ ng</button>
    <button *ngIf="order.status === 'DELIVERED' && !order.supportTicket" 
      class="btn btn-warning"
      (click)="openReportModal(order.id); showReportForm = true">
      BÃ¡o cÃ¡o Ä‘Æ¡n hÃ ng
    </button>
  </div>

  <!-- Hiá»ƒn thá»‹ bÃ¡o cÃ¡o náº¿u Ä‘Ã£ pháº£n há»“i -->
  <div *ngIf="order.supportTicket" class="card shadow-sm mt-4">
    <div class="card-body">
      <h5 class="card-title">ğŸ“ Pháº£n há»“i Ä‘Æ¡n hÃ ng</h5>
      <p>
        <strong>MÃ£ bÃ¡o cÃ¡o:</strong> {{ order.supportTicket.id || 'KhÃ´ng xÃ¡c Ä‘á»‹nh' }}<br>
        <strong>NgÃ y Ä‘áº·t:</strong> {{ order.supportTicket.createdAt | date:'dd/MM/yyyy HH:mm' }}<br>
        <strong>Váº¥n Ä‘á»:</strong> {{ order.supportTicket.issue }}<br>
        <strong>Tráº¡ng thÃ¡i:</strong>
        {{
        order.supportTicket.status === 'PENDING' ? 'Chá» xá»­ lÃ½' :
        order.supportTicket.status === 'REPLIED' ? 'ÄÃ£ pháº£n há»“i' :
        'KhÃ´ng xÃ¡c Ä‘á»‹nh'
        }}
        <br>
        <strong>NgÃ y pháº£n há»“i:</strong> {{ order.supportTicket.repliedAt | date:'dd/MM/yyyy HH:mm' }}<br>
        <strong>Pháº£n há»“i:</strong> {{ order.supportTicket.adminReply }}
      </p>
    </div>
  </div>
</div>

<!-- Form bÃ¡o cÃ¡o Ä‘Æ¡n hÃ ng -->
<div class="custom-report-box" *ngIf="showReportForm">
  <div class="card shadow border">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">BÃ¡o cÃ¡o Ä‘Æ¡n hÃ ng</h5>
      <button type="button" class="btn-close" aria-label="ÄÃ³ng" (click)="closeModal()"></button>
    </div>
    <div class="card-body">
      <form>
        <div class="mb-3">
          <label for="reportContent" class="form-label">Ná»™i dung bÃ¡o cÃ¡o</label>
          <textarea [(ngModel)]="reportContent" name="reportContent" id="reportContent" class="form-control"
            rows="4"></textarea>
        </div>
      </form>
    </div>
    <div class="card-footer text-end">
      <button type="button" class="btn btn-secondary me-2" (click)="closeModal()">Há»§y</button>
      <button class="btn btn-primary" (click)="submitReport()" [disabled]="!reportContent.trim()">Gá»­i bÃ¡o cÃ¡o</button>
    </div>
  </div>
</div>